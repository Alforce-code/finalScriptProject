<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f6f9;
        margin: 0;
        padding: 20px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 1000px;
        margin: auto;
    }

    .card h1 {
        margin-bottom: 20px;
        color: #333;
        font-size: 24px;
        text-align: center;
    }

    .module-select {
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
    }

    .module-select label {
        font-weight: bold;
        font-size: 16px;
        color: #333;
    }

    .module-select select {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 15px;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: 0.3s ease;
    }

    .module-select select:hover {
        border-color: #4CAF50;
        background-color: #fff;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px 12px;
        text-align: center;
    }
    th {
        background-color: #4CAF50;
        color: rgb(10, 10, 10);
        font-size: 18px;
    }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }

    td.distinction { background-color: #d4edda; color: #155724; font-weight: bold; }
    td.pass { background-color: #fff3cd; color: #856404; font-weight: bold; }
    td.fail { background-color: #f8d7da; color: #721c24; font-weight: bold; }

    button {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    button[type="submit"] { background-color: #007bff; color: white; transition: 0.3s; }
    button[type="submit"]:hover:enabled { background-color: #0056b3; }
    button:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.6; }
    button.delete-btn { background-color: #dc3545; color: white; }
    button.delete-btn:hover:enabled { background-color: #a71d2a; }

    input[type="number"] { width: 60px; padding: 5px; }
    tfoot td { border-top: 2px solid #333; font-size: 16px; font-weight: bold; }

    .alert {
        padding: 15px 20px;
        margin: 20px 0;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
</style>
<!-- importing the header -->
<%- include('../partials/header', {title: 'Lecturer Manage Grade'}) %>

<!-- the back button-->
<a href="/lecturer/dashboard"> Back</a>

<div class="card">
    <h1>Manage Grades</h1>

    <!-- Success/Error Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success">
            <% if (success === 'grade_deleted') { %>
                ✓ Grade deleted successfully!
            <% } else if (success === 'grade_updated') { %>
                ✓ Grade updated successfully!
            <% } %>
        </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error && error !== 'Error loading manage grades') { %>
        <div class="alert alert-error">
            <% if (error === 'delete_failed') { %>
                ✗ Failed to delete grade. Please try again.
            <% } else if (error === 'update_failed') { %>
                ✗ Failed to update grade. Please try again.
            <% } else { %>
                ✗ An error occurred. Please try again.
            <% } %>
        </div>
    <% } %>

    <% if (typeof info !== 'undefined' && info) { %>
        <div class="alert alert-info">
            <% if (info === 'grade_not_found') { %>
                ℹ Grade not found, nothing to delete.
            <% } %>
        </div>
    <% } %>

    <!-- Module Selection -->
    <form method="GET" action="/lecturer/manage-grades" class="module-select">
        <label for="module">Select Module:</label>
        <select name="moduleId" id="module" onchange="this.form.submit()">
            <% modules.forEach(m => { %>
                <option value="<%= m.module_id %>" <%= m.module_id == selectedModule ? "selected" : "" %>>
                    <%= m.name %>
                </option>
            <% }) %>
        </select>
    </form>

    <% if (selectedModule && students.length > 0) { %>
        <table>
            <tr>
                <th>Student</th>
                <th>Assessment</th>
                <th>Score</th>
                <th>Overall Score</th>
                <th>Actions</th>
            </tr>

            <% students.forEach(s => { %>
                <% assessments.forEach((a, idx) => {
                    const grade = s.grades.find(g => g.assessment_id === a.assessment_id) || {};
                    const hasGrade = grade.score !== undefined && grade.score !== null;
                %>
                <tr>
                    <td><%= s.first_name %> <%= s.last_name %> (<%= s.registration_number %>)</td>
                    <td><%= a.name %></td>
                    <td>
                        <form method="POST" action="/lecturer/update-grade" class="grade-form">
                            <input
                                type="number"
                                name="score"
                                value="<%= grade.score || '' %>"
                                placeholder="Enter score"
                                required
                                min="0"
                                max="100"
                                class="grade-input"
                                data-original="<%= grade.score || '' %>"
                            />
                            <input type="hidden" name="registrationNumber" value="<%= s.registration_number %>" />
                            <input type="hidden" name="moduleId" value="<%= selectedModule %>" />
                            <input type="hidden" name="assessmentId" value="<%= a.assessment_id %>" />
                            <button type="submit" class="save-btn">Save</button>
                        </form>
                    </td>

                    <% if (idx === 0) { %>
                        <td rowspan="<%= assessments.length %>" 
                            class="<%= s.overall_score >= 70 ? 'distinction' : (s.overall_score >= 50 ? 'pass' : (s.overall_score !== null ? 'fail' : '')) %>">
                            <%= s.overall_score !== null ? s.overall_score : "N/A" %>
                        </td>
                    <% } %>

                    <td>
                        <% if (hasGrade) { %>
                            <form method="POST" action="/lecturer/delete-grade" onsubmit="return confirm('Are you sure you want to delete this grade?')">
                                <input type="hidden" name="registrationNumber" value="<%= s.registration_number %>" />
                                <input type="hidden" name="moduleId" value="<%= selectedModule %>" />
                                <input type="hidden" name="assessmentId" value="<%= a.assessment_id %>" />
                                <button type="submit" class="delete-btn">Delete</button>
                            </form>
                        <% } else { %>
                            <button class="delete-btn" disabled title="No grade to delete">Delete</button>
                        <% } %>
                    </td>
                </tr>
                <% }) %>
            <% }) %>

            <tfoot>
                <tr>
                    <td colspan="3" style="text-align: right;">Class Average:</td>
                    <td colspan="2" style="text-align: center; <%= avgStyle %>">
                        <%= classAverage !== null ? classAverage : "N/A" %>
                    </td>
                </tr>
            </tfoot>
        </table>
    <% } else { %>
        <p style="text-align:center;">No students or assessments found for this module.</p>
    <% } %>
</div>

<%- include('../partials/footer') %>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".grade-input").forEach(input => {
        const form = input.closest(".grade-form");
        const button = form.querySelector(".save-btn");

        // Initial state - disable if there's already a value
        button.disabled = input.value !== "";

        // Enable button only when changed
        input.addEventListener("input", () => {
            button.disabled = input.value === input.dataset.original;
        });

        // After form submit, reset state
        form.addEventListener("submit", () => {
            button.disabled = true;
            input.dataset.original = input.value;
        });
    });

    // Auto-hide alerts after 5 seconds
    const alerts = document.querySelectorAll(".alert");
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.transition = "opacity 0.5s ease-out";
            alert.style.opacity = "0";
            setTimeout(() => alert.remove(), 500);
        }, 5000);
    });
});
</script>